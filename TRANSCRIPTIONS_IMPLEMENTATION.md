# Call Transcriptions Implementation

This document describes the call recording transcriptions functionality in the Xoya-Banjour application.

## Overview

The transcription system fetches call transcripts directly from Telnyx API in real-time. Transcriptions are automatically generated by Telnyx when call recording transcription is enabled, and can be viewed through a dedicated interface.

## Features

- âœ… **Dedicated Transcriptions Page** - Separate interface for viewing all transcriptions
- âœ… **Real-time fetching** from Telnyx API
- âœ… List all transcriptions with filters
- âœ… View full transcript details
- âœ… Search transcripts by content
- âœ… Filter by status and date range
- âœ… Associate with call details (from/to numbers)
- âœ… User-based access control
- âœ… Beautiful responsive UI

## Pages

### 1. Recordings Page (`/recordings`)
- View all call recordings
- **Quick view transcription** via modal (ğŸ“ button)
- Link to dedicated transcriptions page

### 2. Transcriptions Page (`/transcriptions`)
- **Dedicated page** for viewing all transcriptions
- Advanced search and filtering
- Full transcript display in modal
- Table view with preview

## API Endpoints

### List Transcriptions
```
GET /api/transcriptions
```

Query Parameters:
- `status` - Filter by status (completed, processing)
- `date_from` - Filter by creation date (from)
- `date_to` - Filter by creation date (to)
- `recording_id` - Filter by specific recording
- `page_size` - Results per page
- `page_after` - Cursor for pagination

Response:
```json
{
  "success": true,
  "transcriptions": {
    "data": [
      {
        "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
        "recording_id": "abc123...",
        "status": "completed",
        "transcription_text": "Good morning, how may I help you?",
        "duration_millis": 60000,
        "created_at": "2025-10-07T13:00:00.000Z",
        "from_number": "+1234567890",
        "to_number": "+0987654321",
        "direction": "outbound",
        "call": {
          "id": 123,
          "from_number": "+1234567890",
          "to_number": "+0987654321"
        }
      }
    ],
    "meta": {
      "cursors": {
        "after": "...",
        "before": "..."
      }
    }
  }
}
```

### Get Single Transcription
```
GET /api/transcriptions/{transcriptionId}
```

Response:
```json
{
  "success": true,
  "transcription": {
    "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "recording_id": "abc123...",
    "transcription_text": "Full transcript text here...",
    ...
  }
}
```

### Get Transcription by Recording ID
```
GET /api/transcriptions/recording/{recordingId}
```

This endpoint finds the transcription associated with a specific recording.

Response:
```json
{
  "success": true,
  "transcription": {
    "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "recording_id": "abc123...",
    "transcription_text": "Transcript text...",
    ...
  }
}
```

### Get Transcription from Recording (Quick Access)
```
GET /api/recordings/{recordingId}/transcription
```

Used in the recordings page for quick transcription view.

## TranscriptionController Methods

### `index()`
Renders the transcriptions page.

### `list(Request $request)`
Lists all transcriptions from Telnyx API with:
- Filters (status, date range)
- Call data enrichment
- User-based filtering

### `show($transcriptionId)`
Fetches a specific transcription with full details.

### `getByRecording($recordingId)`
Retrieves transcription for a specific recording.

## TelnyxService Methods

### `listRecordingTranscriptions($filters)`
```php
$telnyxService->listRecordingTranscriptions([
    'status' => 'completed',
    'recording_id' => 'abc123',
    'created_at_gte' => '2025-10-01',
    'created_at_lte' => '2025-10-07',
    'page_size' => 50
]);
```

### `getRecordingTranscription($transcriptionId)`
```php
$transcription = $telnyxService->getRecordingTranscription('trans-id-123');
```

### `getRecordingTranscriptionByRecordingId($recordingId)`
```php
$transcription = $telnyxService->getRecordingTranscriptionByRecordingId('rec-id-123');
```

## Frontend Components

### Transcriptions Page Features

**Table View:**
- Date/Time
- Call Details (from/to numbers)
- Transcript Preview (truncated)
- Duration
- Status Badge
- View Action

**Filters:**
- Status filter
- Date range (from/to)
- Text search across transcripts

**Full View Modal:**
- Complete transcript text
- Call information
- Transcription metadata
- IDs for reference

## Usage Examples

### Navigate to Transcriptions
```
From Recordings Page:
1. Click "ğŸ“ View All Transcriptions" button
2. Opens /transcriptions page

Direct Access:
Navigate to /transcriptions
```

### View Transcript Details
```
1. On /transcriptions page
2. Click "ğŸ‘ï¸ View" on any transcription
3. Modal opens with full details
4. Read complete transcript
5. Click âœ• or outside to close
```

### Search Transcripts
```
1. Use search box on transcriptions page
2. Type keywords
3. Results filter automatically
4. Searches in: transcript text, phone numbers, IDs
```

### Filter Transcriptions
```
Status: completed, processing
Date From: 2025-10-01
Date To: 2025-10-07

Click filter dropdowns or date pickers
Results update automatically
```

## Data Flow

### Transcription Fetching:
```
User visits /transcriptions
    â†“
TranscriptionController@index renders page
    â†“
Frontend calls /api/transcriptions
    â†“
TranscriptionController@list
    â†“
TelnyxService->listRecordingTranscriptions()
    â†“
Telnyx API call
    â†“
Enrich with call data from database
    â†“
Filter by user permissions
    â†“
Return to frontend
    â†“
Display in table
```

### View Full Transcript:
```
User clicks "ğŸ‘ï¸ View"
    â†“
Modal opens
    â†“
Shows full transcript text
    â†“
Displays all metadata
```

## Telnyx API Structure

### List Response:
```json
{
  "data": [
    {
      "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
      "recording_id": "abc-123",
      "status": "completed",
      "transcription_text": "Full text here",
      "duration_millis": 60000,
      "created_at": "2025-10-07T13:00:00.000Z",
      "updated_at": "2025-10-07T13:01:00.000Z",
      "record_type": "recording_transcription"
    }
  ],
  "meta": {
    "cursors": {
      "after": "cursor-string",
      "before": "cursor-string"
    },
    "next": "/v2/recording_transcriptions?page[after]=...",
    "previous": "/v2/recording_transcriptions?page[before]=..."
  }
}
```

## Security

### Access Control
- Users can only view transcriptions for their own calls
- Super-admins can view all transcriptions
- Authorization checked via associated call ownership

### Permission Checks
```php
// In TranscriptionController
if (!Auth::user()->hasRole('super-admin') && $call->user_id !== Auth::id()) {
    return 403 Unauthorized;
}
```

## Enabling Transcriptions in Telnyx

### 1. Enable Recording Transcription
```php
// When starting a call with recording
$call = $telnyxService->createCall([
    'from' => '+1234567890',
    'to' => '+0987654321',
    'record' => 'record-from-answer',
    'transcription_engine' => 'A',  // Enable transcription
    'transcription_language' => 'en' // Language code
]);
```

### 2. Transcription Options
- `transcription_engine` - 'A' or 'B' (Telnyx transcription engines)
- `transcription_language` - Language code (en, es, fr, etc.)

### 3. Webhook Events (Optional)
- `recording.transcription.ready` - Triggered when transcription completes

## UI Screenshots

### Transcriptions Table
```
Date/Time       | Call Details              | Preview              | Duration | Status
----------------|---------------------------|----------------------|----------|----------
Oct 7, 1:30 PM | +1234567890 â†’ +0987654321 | Good morning, how... | 01:23   | completed
Oct 7, 1:25 PM | +0987654321 â†’ +1234567890 | Thank you for...     | 00:45   | completed
```

### Full Transcript Modal
```
Full Transcription
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Call Information              Transcription Details
From: +1234567890            Date: Oct 7, 2025
To: +0987654321              Duration: 01:23
Direction: Outbound          Status: [completed]

Full Transcript:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Good morning, how may I help you?

Yes, I'm calling about my account...

[Full conversation continues...]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Transcription ID: 3fa85f64-5717-4562-b3fc-2c963f66afa6
Recording ID: abc-123-def-456
Last updated: Oct 7, 2025 1:31 PM
```

## Troubleshooting

### No Transcriptions Appearing

1. **Check if transcription is enabled**
   - Verify `transcription_engine` is set when recording
   - Check Telnyx Mission Control settings

2. **Check transcription status**
   - Transcriptions may take time to process
   - Status will be "processing" until complete

3. **Check logs**
   ```bash
   tail -f storage/logs/laravel.log | grep "transcription"
   ```

### Transcription Not Found

1. **Recording may not have transcription**
   - Not all recordings have transcriptions
   - Transcription must be enabled when recording starts

2. **Still processing**
   - Check status in Telnyx API
   - Wait for processing to complete

## Best Practices

1. **Enable transcription at call start**
   - Set transcription engine when initiating call
   - Specify correct language code

2. **Use search effectively**
   - Search by keywords in transcript
   - Filter by date range for better results

3. **Check status before viewing**
   - Only "completed" transcriptions have full text
   - "processing" status means wait a bit longer

## Future Enhancements

- [ ] Export transcripts to PDF/TXT
- [ ] Keyword highlighting in search results
- [ ] Speaker identification (if supported by Telnyx)
- [ ] Sentiment analysis
- [ ] Transcript editing/annotation
- [ ] Integration with CRM systems
- [ ] Automatic summary generation
- [ ] Multi-language support display

## Resources

- [Telnyx Recording Transcriptions API](https://developers.telnyx.com/docs/api/v2/call-recording/recording-transcriptions)
- [Telnyx Transcription Engines](https://developers.telnyx.com/docs/voice/transcription)

## Support

For issues:
1. Check transcription is enabled in call settings
2. Verify Telnyx API key permissions
3. Check logs: `storage/logs/laravel.log`
4. Ensure recording completed successfully

